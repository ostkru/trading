#!/bin/bash

# ๐งช ะกะบัะธะฟั ะทะฐะฟััะบะฐ ะฒัะตั ัะตััะพะฒ Trading API

echo "๐งช ะะฐะฟััะบ ะฒัะตั ัะตััะพะฒ Trading API..."
echo "=================================="

# ะัะพะฒะตััะตะผ, ััะพ ะผั ะฒ ะฟะฐะฟะบะต tests
if [ ! -f "README.md" ]; then
    echo "โ ะะฐะฟััะบะฐะนัะต ัะบัะธะฟั ะธะท ะฟะฐะฟะบะธ tests/"
    exit 1
fi

# ะกะพะทะดะฐะตะผ ะฟะฐะฟะบั ะดะปั ัะตะทัะปััะฐัะพะฒ
mkdir -p results
timestamp=$(date +"%Y%m%d_%H%M%S")

echo "๐ ะัะตะผั ะทะฐะฟััะบะฐ: $(date)"
echo ""

# 1. API ัะตััั
echo "๐ ะะฐะฟััะบ API ัะตััะพะฒ..."
cd api
if [ -f "test_redis_rate_limiting.php" ]; then
    echo "  - Redis Rate Limiting ัะตััั..."
    php test_redis_rate_limiting.php > "../results/api_redis_${timestamp}.log" 2>&1
    if [ $? -eq 0 ]; then
        echo "  โ Redis ัะตััั ะทะฐะฒะตััะตะฝั"
    else
        echo "  โ Redis ัะตััั ะทะฐะฒะตััะธะปะธัั ั ะพัะธะฑะบะฐะผะธ"
    fi
else
    echo "  โ๏ธ Redis ัะตััั ะฝะต ะฝะฐะนะดะตะฝั"
fi
cd ..

echo ""

# 2. ะะฝัะตะณัะฐัะธะพะฝะฝัะต ัะตััั
echo "๐ ะะฐะฟััะบ ะธะฝัะตะณัะฐัะธะพะฝะฝัั ัะตััะพะฒ..."
cd integration
if [ -f "comprehensive_improved.php" ]; then
    echo "  - ะะพะผะฟะปะตะบัะฝัะต ัะตััั..."
    php comprehensive_improved.php > "../results/integration_${timestamp}.log" 2>&1
    if [ $? -eq 0 ]; then
        echo "  โ ะะฝัะตะณัะฐัะธะพะฝะฝัะต ัะตััั ะทะฐะฒะตััะตะฝั"
    else
        echo "  โ ะะฝัะตะณัะฐัะธะพะฝะฝัะต ัะตััั ะทะฐะฒะตััะธะปะธัั ั ะพัะธะฑะบะฐะผะธ"
    fi
else
    echo "  โ๏ธ ะะพะผะฟะปะตะบัะฝัะต ัะตััั ะฝะต ะฝะฐะนะดะตะฝั"
fi
cd ..

echo ""

# 3. ะะพะดัะปัะฝัะต ัะตััั (ะตัะปะธ ะตััั)
echo "๐งฉ ะัะพะฒะตัะบะฐ ะผะพะดัะปัะฝัั ัะตััะพะฒ..."
cd unit
if [ "$(ls -A)" ]; then
    echo "  - ะะพะดัะปัะฝัะต ัะตััั ะฝะฐะนะดะตะฝั"
    for test_file in *.php; do
        if [ -f "$test_file" ]; then
            echo "    - ะะฐะฟััะบ $test_file..."
            php "$test_file" > "../results/unit_${test_file%.php}_${timestamp}.log" 2>&1
        fi
    done
else
    echo "  โน๏ธ ะะพะดัะปัะฝัะต ัะตััั ะฝะต ะฝะฐะนะดะตะฝั"
fi
cd ..

echo ""

# 4. ะขะตััั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ (ะตัะปะธ ะตััั)
echo "โก ะัะพะฒะตัะบะฐ ัะตััะพะฒ ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ..."
cd performance
if [ "$(ls -A)" ]; then
    echo "  - ะขะตััั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ ะฝะฐะนะดะตะฝั"
    for test_file in *.php; do
        if [ -f "$test_file" ]; then
            echo "    - ะะฐะฟััะบ $test_file..."
            php "$test_file" > "../results/performance_${test_file%.php}_${timestamp}.log" 2>&1
        fi
    done
else
    echo "  โน๏ธ ะขะตััั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ ะฝะต ะฝะฐะนะดะตะฝั"
fi
cd ..

echo ""
echo "=================================="
echo "๐ ะะตะทัะปััะฐัั ัะตััะพะฒ ัะพััะฐะฝะตะฝั ะฒ ะฟะฐะฟะบั results/"
echo "๐ ะัะตะผั ะทะฐะฒะตััะตะฝะธั: $(date)"
echo "๐ ะัะต ัะตััั ะทะฐะฒะตััะตะฝั!"
