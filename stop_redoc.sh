#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ Redoc —Å–µ—Ä–≤–µ—Ä–∞

PORT=8182
PID_FILE="redoc.pid"

echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Redoc —Å–µ—Ä–≤–µ—Ä–∞..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ PID —Ñ–∞–π–ª
if [ ! -f "$PID_FILE" ]; then
    echo "‚ÑπÔ∏è  PID —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É $PORT..."
    
    # –ò—â–µ–º –ø—Ä–æ—Ü–µ—Å—Å –ø–æ –ø–æ—Ä—Ç—É
    PID=$(lsof -ti:$PORT 2>/dev/null)
    if [ -z "$PID" ]; then
        echo "‚úÖ Redoc —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω"
        exit 0
    else
        echo "üîç –ù–∞–π–¥–µ–Ω –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞ –ø–æ—Ä—Ç—É $PORT (PID: $PID)"
    fi
else
    PID=$(cat "$PID_FILE")
    echo "üìã –ò—Å–ø–æ–ª—å–∑—É–µ–º PID –∏–∑ —Ñ–∞–π–ª–∞: $PID"
fi

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å
if [ ! -z "$PID" ]; then
    echo "üîÑ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ $PID..."
    kill $PID
    
    # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    sleep 2
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
    if ps -p $PID > /dev/null 2>&1; then
        echo "‚ö†Ô∏è  –ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ–º..."
        kill -9 $PID
        sleep 1
    fi
    
    # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
    if ps -p $PID > /dev/null 2>&1; then
        echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å $PID"
        exit 1
    else
        echo "‚úÖ Redoc —Å–µ—Ä–≤–µ—Ä —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        rm -f "$PID_FILE"
    fi
else
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ—Ä—Ç –æ—Å–≤–æ–±–æ–¥–∏–ª—Å—è
if lsof -ti:$PORT > /dev/null 2>&1; then
    echo "‚ö†Ô∏è  –ü–æ—Ä—Ç $PORT –≤—Å–µ –µ—â–µ –∑–∞–Ω—è—Ç"
else
    echo "‚úÖ –ü–æ—Ä—Ç $PORT –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω"
fi 